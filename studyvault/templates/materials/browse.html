{% extends "base.html" %}
{% block title %}Browse Materials ‚Äî StudyVault{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <h1 class="text-2xl font-semibold mb-4">Browse Materials</h1>

  <!-- Search -->
  <form method="get" class="mb-6 flex gap-2">
    <input type="text" name="q" value="{{ request.GET.q }}"
           placeholder="Search by title or description..."
           class="flex-1 rounded-md border px-3 py-2 text-sm">
    <button type="submit"
            class="rounded-md border px-4 py-2 text-sm bg-white hover:bg-black hover:text-white">
      Search
    </button>
  </form>

    <!-- CSRF holder (hidden) -->
<form id="csrf-holder" style="display:none;">{% csrf_token %}</form>


  <!-- List -->
  <div class="space-y-4">
    {% for m in materials %}
<div class="border rounded-lg p-4 hover:shadow-sm" data-card="material">
        <h2 class="font-medium text-lg">
            {{ m.title }}
        </h2>
        <p class="text-sm text-gray-600 mb-2">{{ m.description|truncatewords:25 }}</p>
        <p class="text-xs text-gray-500 mb-2">
          {{ m.category.name }} | {{ m.department.name }} | {{ m.semester.name }}
        </p>

        <!-- üëá ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶≤‡¶ï: uploader ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá -->
        <p class="text-sm text-gray-500 mb-2">
          Uploaded by
          <a href="{% url 'profile' m.uploader.username %}"
             class="underline hover:no-underline hover:text-blue-600">
            {{ m.uploader.username }}
          </a>
          &middot; {{ m.created_at|date:"M j, Y" }}
        </p>

        <a href="{{ m.file.url }}" class="text-blue-600 hover:underline" download>Download</a>
        <span class="text-xs text-gray-500">({{ m.download_count }} downloads)</span>

        <!-- Upvote button -->
<button class="upvote-btn text-sm text-blue-600 underline"
        data-id="{{ m.pk }}">
  Upvote (<span data-count="up">{{ m.upvotes.count }}</span>)
</button>

<!-- Downvote button -->
<button class="downvote-btn text-sm text-red-600 underline"
        data-id="{{ m.pk }}">
  Downvote (<span data-count="down">{{ m.downvotes.count }}</span>)
</button>

<div class="mt-4">
  <h3 class="text-sm font-semibold mb-2" data-comments-count>
    Comments ({{ m.comments.count }})
  </h3>

  <ul id="comments-{{ m.pk }}" class="bg-gray-50 rounded border divide-y">
    {% for c in m.comments.all %}
      {% include "materials/_comment.html" with c=c %}
    {% empty %}
      <li class="p-3 text-sm text-gray-500">No comments yet.</li>
    {% endfor %}
  </ul>

  {% if user.is_authenticated %}
    <form class="comment-form mt-3" data-id="{{ m.pk }}">
        <textarea name="body" rows="2"
          class="w-full border rounded px-3 py-2 text-sm"
          placeholder="Write a comment‚Ä¶"></textarea>

      <div class="mt-2">
        <button type="submit"
                class="px-3 py-1.5 text-sm border rounded hover:bg-black hover:text-white">
          Add comment
        </button>
      </div>
    </form>
  {% else %}
    <p class="text-xs text-gray-500 mt-2">
      Please <a href="{% url 'login' %}" class="underline">log in</a> to comment.
    </p>
  {% endif %}
</div>


      </div>
    {% empty %}
      <p class="text-gray-600">No materials found.</p>
    {% endfor %}
  </div>

  <!-- Pagination -->
  <div class="mt-6">
    {% if materials.has_previous %}
      <a href="?page={{ materials.previous_page_number }}" class="px-3 py-1 border rounded">Previous</a>
    {% endif %}
    <span class="mx-2">Page {{ materials.number }} of {{ materials.paginator.num_pages }}</span>
    {% if materials.has_next %}
      <a href="?page={{ materials.next_page_number }}" class="px-3 py-1 border rounded">Next</a>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // ‚úÖ CSRF token (hidden form ‡¶•‡ßá‡¶ï‡ßá)
  const csrfInput = document.querySelector('#csrf-holder input[name="csrfmiddlewaretoken"]');
  const csrftoken = csrfInput ? csrfInput.value : "";

  // ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶æ ‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡ßá (data-card="material") ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞ ‡¶≤‡¶æ‡¶ó‡¶æ‡¶ì
  document.querySelectorAll('[data-card="material"]').forEach(card => {
    const upBtn   = card.querySelector('.upvote-btn');
    const downBtn = card.querySelector('.downvote-btn');

    const upSpan   = card.querySelector('[data-count="up"]');
    const downSpan = card.querySelector('[data-count="down"]');

    function post(url, onDone) {
      // ‡¶°‡¶æ‡¶¨‡¶≤-‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶†‡ßá‡¶ï‡¶æ‡¶§‡ßá ‡¶¶‡ßÅ‡¶á ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡¶æ‡¶Æ‡ßü‡¶ø‡¶ï ‡¶¨‡¶®‡ßç‡¶ß
      upBtn.disabled = true;
      downBtn.disabled = true;

      fetch(url, {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({})
      })
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(data => {
        // ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶Ø‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡ßü ‡¶∏‡ßá‡¶ü‡¶æ‡¶á ‡¶¨‡¶∏‡¶æ‡¶ì ‚Äî ‡¶¶‡ßÅ‚Äô‡¶¶‡¶ø‡¶ï ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶¨‡ßá
        if (data.total_upvotes !== undefined)  upSpan.textContent   = data.total_upvotes;
        if (data.total_downvotes !== undefined) downSpan.textContent = data.total_downvotes;

        // ‡¶á‡¶ö‡ßç‡¶õ‡¶æ ‡¶π‡¶≤‡ßá active ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶ü‡¶ó‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßã
        upBtn.classList.toggle('font-semibold',   data.your_vote === 'up');
        downBtn.classList.toggle('font-semibold', data.your_vote === 'down');
      })
      .catch(() => {
        alert("Something went wrong. Please try again.");
      })
      .finally(() => {
        upBtn.disabled = false;
        downBtn.disabled = false;
      });
    }

    // Upvote handler
    upBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const id = upBtn.dataset.id;
      post("{% url 'materials:toggle_upvote' 0 %}".replace("0", id));
    });

    // Downvote handler
    downBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const id = downBtn.dataset.id;
      post("{% url 'materials:toggle_downvote' 0 %}".replace("0", id));
    });
  });

  // ‚úÖ Comment submit (AJAX) ‚Äî DEBUG ‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶®
document.querySelectorAll(".comment-form").forEach(form => {
  form.addEventListener("submit", function (e) {
    e.preventDefault();

    const materialId = this.dataset.id;
    const textarea = this.querySelector('textarea[name="body"]');
    const text = (textarea.value || "").trim();
    if (!text) return; // ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶π‡¶≤‡ßá ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßã ‡¶®‡¶æ

    fetch("{% url 'materials:add_comment' 0 %}".replace("0", materialId), {
      method: "POST",
      credentials: "same-origin",
      headers: {
        "X-CSRFToken": csrftoken,
        "X-Requested-With": "XMLHttpRequest",
        "Content-Type": "application/x-www-form-urlencoded"
      },
        body: new URLSearchParams({ body: text })
    })
    .then(async (r) => {
      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        // ‚ùó ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ form.errors ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá
        alert("Could not add comment.\n" + (data && data.errors ? JSON.stringify(data.errors) : ""));
        console.log("Comment form errors:", data);
        throw new Error("comment failed");
      }
      return data;
    })
    .then(data => {
      // ‚úÖ ‡¶∏‡¶´‡¶≤ ‡¶π‡¶≤‡ßá ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶Æ‡¶§‡¶á UI ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
      const ul = document.getElementById(`comments-${materialId}`);
      const empty = ul.querySelector(".p-3.text-sm.text-gray-500");
      if (empty) empty.remove();
      ul.insertAdjacentHTML("beforeend", data.html);
      textarea.value = "";
      const countEl = this.closest('[data-card="material"]').querySelector("[data-comments-count]");
      if (countEl) countEl.textContent = `Comments (${data.count})`;
    })
    .catch(() => { /* already alerted */ });
  });
});

// 1) Reply ‡¶´‡¶∞‡ßç‡¶Æ ‡¶ü‡¶ó‡¶≤ (show/hide)
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.reply-toggle');
    if (!btn) return;

    e.preventDefault();
    const parentId = btn.dataset.parent;                 // ‡¶Ø‡ßá‡¶ü‡¶æ‡¶§‡ßá reply ‡¶¶‡¶ø‡¶ö‡ßç‡¶õ‡¶ø ‡¶§‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø
    const li = document.getElementById(`comment-${parentId}`);
    const form = li ? li.querySelector('.reply-form') : null;
    if (form) {
      form.classList.toggle('hidden');
      if (!form.classList.contains('hidden')) {
        const ta = form.querySelector('textarea[name="body"]');
        if (ta) ta.focus();
      }
    }
  });

  // 2) Reply ‡¶´‡¶∞‡ßç‡¶Æ cancel
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.reply-cancel');
    if (!btn) return;

    e.preventDefault();
    const form = btn.closest('.reply-form');
    if (form) form.classList.add('hidden');
  });

  // 3) Reply ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü (AJAX)
  document.addEventListener('submit', function (e) {
    const form = e.target.closest('.reply-form');
    if (!form) return;

    e.preventDefault();

    const materialId = form.dataset.id;
    const parentId   = form.dataset.parent;
    const textarea   = form.querySelector('textarea[name="body"]');
    const body       = (textarea.value || '').trim();
    if (!body) return;

    fetch("{% url 'materials:add_reply' 0 %}".replace("0", materialId), {
      method: "POST",
      credentials: "same-origin",
      headers: {
        "X-CSRFToken": csrftoken,                 // ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶ï‡ßã‡¶°‡ßá ‡¶°‡¶ø‡¶´‡¶æ‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá
        "X-Requested-With": "XMLHttpRequest",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({ body, parent_id: parentId })
    })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) throw new Error("reply failed");

      // parent LI ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá child UL ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¨‡¶æ‡¶®‡¶æ‡¶á, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® reply ‡¶¢‡ßÅ‡¶ï‡¶æ‡¶á
      const parentLi = document.getElementById(`comment-${parentId}`);
      let childrenUl = parentLi ? parentLi.querySelector('ul') : null;
      if (!childrenUl) {
        childrenUl = document.createElement('ul');
        childrenUl.className = 'mt-3 pl-4 border-l';
        parentLi.appendChild(childrenUl);
      }
      childrenUl.insertAdjacentHTML('beforeend', data.html);

      textarea.value = '';
      form.classList.add('hidden');
    })
    .catch(() => alert("Could not post reply. Please try again."));
  });


 // üóëÔ∏è Delete comment (DEBUG: show status & response)
document.addEventListener("click", function (e) {
  const btn = e.target.closest(".comment-delete");
  if (!btn) return;

  e.preventDefault();
  const commentId = btn.dataset.comment;
  if (!confirm("Delete this comment?")) return;

  const url = "{% url 'materials:delete_comment' 0 %}".replace("0", commentId);

  fetch(url, {
    method: "POST",
    credentials: "same-origin",
    headers: {
      "X-CSRFToken": csrftoken,
      "X-Requested-With": "XMLHttpRequest",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({})
  })
  .then(async (r) => {
    const text = await r.text(); // raw ‡¶¶‡ßá‡¶ñ‡¶¨
    let data = {};
    try { data = JSON.parse(text); } catch (_) {}
    if (!r.ok) {
      alert(`DELETE failed.\nStatus: ${r.status}\nBody: ${text}`);
      throw new Error("delete failed");
    }
    if (!data.ok) {
      alert(`Server said not ok.\nPayload: ${text}`);
      throw new Error("delete not ok");
    }
    // ‚úÖ ‡¶∏‡¶´‡¶≤: UI ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶∞‡¶æ‡¶á
    const li = document.getElementById(`comment-${data.comment_id}`);
    if (li) {
      const card = li.closest('[data-card="material"]');
      li.remove();
      const countEl = card ? card.querySelector("[data-comments-count]") : null;
      if (countEl) {
        const m = countEl.textContent.match(/\d+/);
        if (m) countEl.textContent = `Comments (${Math.max(0, parseInt(m[0], 10) - 1)})`;
      }
    }
  })
  .catch((err) => {
    // console ‡¶è‡¶ì ‡¶∞‡¶æ‡¶ñ‡¶ø
    console.error("Delete error:", err);
  });
});


});
</script>



{% endblock %}
